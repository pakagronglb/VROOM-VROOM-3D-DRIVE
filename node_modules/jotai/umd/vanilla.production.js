!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((n="undefined"!=typeof globalThis?globalThis:n||self).jotaiVanilla={})}(this,(function(n){"use strict";var t=0;function r(n){return n(this)}function e(n,t,r){return t(this,"function"==typeof r?r(n(this)):r)}function i(n,t){(null==t||t>n.length)&&(t=n.length);for(var r=0,e=new Array(t);r<t;r++)e[r]=n[r];return e}function o(n,t){var r="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(r)return(r=r.call(n)).next.bind(r);if(Array.isArray(n)||(r=function(n,t){if(n){if("string"==typeof n)return i(n,t);var r=Object.prototype.toString.call(n).slice(8,-1);return"Object"===r&&n.constructor&&(r=n.constructor.name),"Map"===r||"Set"===r?Array.from(n):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(n,t):void 0}}(n))||t&&n&&"number"==typeof n.length){r&&(n=r);var e=0;return function(){return e>=n.length?{done:!0}:{done:!1,value:n[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=function(n,t){return n.unstable_is?n.unstable_is(t):t===n},f=function(n){return"init"in n},c=function(n){return!!n.write},v=new WeakMap,l=function(n,t){var r=v.get(n);r&&(v.delete(n),r(t))},d=function(n,t){n.status="fulfilled",n.value=t},s=function(n,t){n.status="rejected",n.reason=t},h=function(n,t){return!!n&&"v"in n&&"v"in t&&Object.is(n.v,t.v)},g=function(n,t){return!!n&&"e"in n&&"e"in t&&Object.is(n.e,t.e)},p=function(n){return!!n&&"v"in n&&n.v instanceof Promise},y=function(n){if("e"in n)throw n.e;return n.v},w=function(){var n=new WeakMap,t=new WeakMap,r=new Map,e=function(t){return n.get(t)},i=function(t,i){var o=e(t);if(n.set(t,i),r.has(t)||r.set(t,o),p(o)){var a="v"in i?i.v instanceof Promise?i.v:Promise.resolve(i.v):Promise.reject(i.e);o.v!==a&&l(o.v,a)}},a=function(n,t,r,e){var i=new Map(e?t.d:null),o=!1;r.forEach((function(r,e){!r&&u(n,e)&&(r=t),r&&(i.set(e,r),t.d.get(e)!==r&&(o=!0))})),(o||t.d.size!==i.size)&&(t.d=i)},w=function(n,t,r,o){var u,f,c=e(n),v={d:(null==c?void 0:c.d)||new Map,v:t};if(r&&a(n,v,r,o),h(c,v)&&c.d===v.d)return c;if(p(c)&&p(v)&&(f=v,"v"in(u=c)&&"v"in f&&u.v.orig&&u.v.orig===f.v.orig)){if(c.d===v.d)return c;v.v=c.v}return i(n,v),v},m=function(n,r,i,o){if("function"==typeof(null==(c=r)?void 0:c.then)){var a,u=function(){var r=e(n);if(p(r)&&r.v===f){var o=w(n,f,i);t.has(n)&&r.d!==o.d&&z(n,o,r.d)}},f=new Promise((function(n,t){var e=!1;r.then((function(t){e||(e=!0,d(f,t),n(t),u())}),(function(n){e||(e=!0,s(f,n),t(n),u())})),a=function(t){e||(e=!0,t.then((function(n){return d(f,n)}),(function(n){return s(f,n)})),n(t))}}));return f.orig=r,f.status="pending",function(n,t){v.set(n,t),n.catch((function(){})).finally((function(){return v.delete(n)}))}(f,(function(n){n&&a(n),null==o||o()})),w(n,f,i,!0)}var c;return w(n,r,i)},b=function n(r,o){var v=e(r);if(!o&&v){if(t.has(r))return v;if(Array.from(v.d).every((function(t){var e=t[0],i=t[1];if(e===r)return!0;var o=n(e);return o===i||h(o,i)})))return v}var l,d,s=new Map,p=!0,w={get signal(){return l||(l=new AbortController),l.signal},get setSelf(){return!d&&c(r)&&(d=function(){if(!p){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return M.apply(void 0,[r].concat(t))}}),d}};try{var b=r.read((function(t){if(u(r,t)){var i=e(t);if(i)return s.set(t,i),y(i);if(f(t))return s.set(t,void 0),t.init;throw new Error("no atom init")}var o=n(t);return s.set(t,o),y(o)}),w);return m(r,b,s,(function(){var n;return null==(n=l)?void 0:n.abort()}))}catch(n){return function(n,t,r){var o=e(n),u={d:(null==o?void 0:o.d)||new Map,e:t};return r&&a(n,u,r),g(o,u)&&o.d===u.d?o:(i(n,u),u)}(r,n,s)}finally{p=!1}},S=function(n,t){return!t.l.size&&(!t.t.size||1===t.t.size&&t.t.has(n))},A=function(n){var i=new Array,a=new Set;!function n(u){if(!a.has(u)){a.add(u);for(var f,c=o(function(n){var i,o=new Set(null==(i=t.get(n))?void 0:i.t);return r.forEach((function(t,r){var i;null!=(i=e(r))&&i.d.has(n)&&o.add(r)})),o}(u));!(f=c()).done;){var v=f.value;u!==v&&n(v)}i.push(u)}}(n);for(var u=new Set([n]),f=i.length-1;f>=0;--f){var c=i[f],v=e(c);if(v){for(var l,d=!1,s=o(v.d.keys());!(l=s()).done;){var g=l.value;if(g!==c&&u.has(g)){d=!0;break}}if(d){var p=b(c,!0);h(v,p)||u.add(c)}}}},E=function n(t){for(var r=!0,i=arguments.length,o=new Array(i>1?i-1:0),a=1;a<i;a++)o[a-1]=arguments[a];var c=t.write.apply(t,[function(n){return y(b(n))},function(i){for(var o,a=arguments.length,c=new Array(a>1?a-1:0),v=1;v<a;v++)c[v-1]=arguments[v];if(u(t,i)){if(!f(i))throw new Error("atom not writable");var l=e(i),d=m(i,c[0]);h(l,d)||A(i)}else o=n.apply(void 0,[i].concat(c));return r||P(),o}].concat(o));return r=!1,c},M=function(n){for(var t=arguments.length,r=new Array(t>1?t-1:0),e=1;e<t;e++)r[e-1]=arguments[e];var i=E.apply(void 0,[n].concat(r));return P(),i},j=function n(r,i,o){var a,u=o||[];null==(a=e(r))||a.d.forEach((function(e,i){var o=t.get(i);o?o.t.add(r):i!==r&&n(i,r,u)})),b(r);var f={t:new Set(i&&[i]),l:new Set};if(t.set(r,f),c(r)&&r.onMount){var v=r.onMount;u.push((function(){var n=v((function(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return M.apply(void 0,[r].concat(t))}));n&&(f.u=n)}))}return o||u.forEach((function(n){return n()})),f},k=function n(r){var i,o=null==(i=t.get(r))?void 0:i.u;o&&o(),t.delete(r);var a=e(r);a&&(p(a)&&l(a.v),a.d.forEach((function(e,i){if(i!==r){var o=t.get(i);o&&(o.t.delete(r),S(i,o)&&n(i))}})))},z=function(n,r,e){var i=new Set(r.d.keys()),o=new Set;null==e||e.forEach((function(r,e){if(i.has(e))i.delete(e);else{o.add(e);var a=t.get(e);a&&a.t.delete(n)}})),i.forEach((function(r){var e=t.get(r);e?e.t.add(n):t.has(n)&&j(r,n)})),o.forEach((function(n){var r=t.get(n);r&&S(n,r)&&k(n)}))},P=function(){for(;r.size;){var n=Array.from(r);r.clear(),n.forEach((function(n){var r=n[0],i=n[1],o=e(r);if(o){var a=t.get(r);a&&o.d!==(null==i?void 0:i.d)&&z(r,o,null==i?void 0:i.d),a&&(p(i)||!h(i,o)&&!g(i,o))&&a.l.forEach((function(n){return n()}))}}))}};return{get:function(n){return y(b(n))},set:M,sub:function(n,r){var e=function(n){var r=t.get(n);return r||(r=j(n)),r}(n);P();var i=e.l;return i.add(r),function(){i.delete(r),function(n){var r=t.get(n);r&&S(n,r)&&k(n)}(n)}}}};n.atom=function(n,i){var o="atom"+ ++t,a={toString:function(){return o}};return"function"==typeof n?a.read=n:(a.init=n,a.read=r,a.write=e),i&&(a.write=i),a},n.createStore=w,n.getDefaultStore=function(){return a||(a=w()),a}}));
